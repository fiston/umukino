/* Umukino :: Copyright Rowan Seymour 2011 :: https://github.com/rowanseymour/umukino */ var umu={ui:{}};function __extends(a,e,c){a.apply(e,c)}function __retain(a){eval("obj.super$"+a+" = obj."+a)}function Vector2(a,e){this.x=a;this.y=e}Vector2.prototype.clone=function(){return new Vector2(this.x,this.y)};Vector2.prototype.add=function(a){return new Vector2(this.x+a.x,this.y+a.y)};Vector2.prototype.subtract=function(a){return new Vector2(this.x-a.x,this.y-a.y)};Vector2.prototype.scale=function(a){return new Vector2(this.x*a,this.y*a)};
Vector2.prototype.dot=function(a){return this.x*a.x+this.y*a.y};Vector2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector2.prototype.length2=function(){return this.x*this.x+this.y*this.y};Vector2.prototype.equals=function(a){return this==a||this.x==a.x&&this.y==a.y};function Vector3(a,e,c){this.x=a;this.y=e;this.z=c}Vector3.prototype.clone=function(){return new Vector3(this.x,this.y,this.z)};
Vector3.prototype.add=function(a){return new Vector3(this.x+a.x,this.y+a.y,this.z+a.z)};Vector3.prototype.subtract=function(a){return new Vector3(this.x-a.x,this.y-a.y,this.z-a.z)};Vector3.prototype.scale=function(a){return new Vector3(this.x*a,this.y*a,this.z*a)};Vector3.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};Vector3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};
Vector3.prototype.length2=function(){return this.x*this.x+this.y*this.y+this.z*this.z};Vector3.prototype.equals=function(a){return this==a||this.x==a.x&&this.y==a.y&&this.z==a.z};
umu.Timer=function(a,e,c){this.host=a;this.callback=e;this.idleMs=c;this.timerId=0;eval("$timer_"+this.id+" = this;");this.start=function(){this._requestNextTick()};this.stop=function(){clearTimeout(this.timerId)};this._requestNextTick=function(){this.timerId=setTimeout("$timer_"+this.id+"._tick()",this.idleMs)};this._tick=function(){this.callback.apply(this.host,[(new Date).getTime()]);this._requestNextTick()}};
umu.Resources=function(){this.imagePaths=[];this.audioPaths=[];this.loadedCount=this.count=0;var a=this;this.addImage=function(a,c){this.imagePaths.push([a,c]);++this.count};this.addAudio=function(a,c){this.audioPaths.push([a,c]);++this.count};this.load=function(a,c){this.loadedCount=0;this.onLoaded=a;this.onProgress=c;this.image={};this.audio={};for(var d=0;d<this.imagePaths.length;++d){var b=this.imagePaths[d][0],f=this.imagePaths[d][1];this.image[b]=new Image;this.image[b].onload=this._onResourceLoad;
this.image[b].src=f}for(d=0;d<this.audioPaths.length;++d)b=this.audioPaths[d][0],f=this.audioPaths[d][1],this.audio[b]=new Audio(f),this._bindEvent(this.audio[b],"canplaythrough",this._onResourceLoad),this.audio[b].load()};this._bindEvent=function(a,c,d){return a.addEventListener(c,function f(){a.removeEventListener(c,f);return d()},!0)};this._onResourceLoad=function(){++a.loadedCount;if("function"===typeof a.onProgress)a.onProgress(100*a.loadedCount/a.count);if(a.loadedCount==a.count&&"function"===
typeof a.onLoaded)a.onLoaded()}};umu.ui.Component=function(a,e,c,d,b){this.parent=a;this.x=e;this.y=c;this.width=d;this.height=b;this.children=[];this.layout_x=a?a.layout_x+e:0;this.layout_y=a?a.layout_y+c:0;this.parent&&this.parent.children.push(this);this.draw=function(){};this.drawChildren=function(a){for(var b=0;b<this.children.length;++b){var c=this.children[b];a.translate(c.x,c.y);c.draw(a);c.drawChildren(a);a.translate(-c.x,-c.y)}}};
umu.ui.Screen=function(a){__extends(umu.ui.Component,this,[null,0,0,a.width,a.height]);this.canvas=a;this.draw=function(){this.drawChildren(this.canvas.getContext("2d"))}};umu.ui.Panel=function(a,e,c,d,b,f){__extends(umu.ui.Component,this,[a,e,c,d,b]);this.fillStyle=f;this.draw=function(a){a.fillStyle=this.fillStyle;a.fillRect(0,0,this.width,this.height)}};
umu.ui.Label=function(a,e,c,d,b,f,g){__extends(umu.ui.Panel,this,[a,e,c,d,b,f]);__retain("draw",this);this.text=g;this.draw=function(a){this.super$draw(a);a.textAlign="center";a.textBaseline="middle";a.fillStyle="#000";a.fillText(this.text,this.width/2,this.height/2)}};
umu.ui.LoadingScreen=function(a){__extends(umu.ui.Screen,this,[a]);this.progress=0;this.draw=function(){var a=this.canvas.getContext("2d");a.font="20pt Courier";a.fillStyle="#000";a.fillRect(0,0,this.canvas.width,this.canvas.height);a.fillStyle="#FFF";a.fillText("Loading:"+this.progress+"%",5,this.canvas.height-5)}};var STATE_LOADING=0,STATE_READY=1,STATE_RUNNING=2,STATE_PAUSED=3,STATE_FINISHED=4,game_count=0;
umu.Host=function(a,e,c,d){this.game=a;this.game.host=this;this.resources=e;this.canvas=null;this.state=STATE_LOADING;this.id=++game_count;this.updateTimeAvg=this.updatePrevTime=0;var b=this;$(document).ready(function(){b._init(d)});this.keys=[];document.onkeydown=function(a){b.keys[a.keyCode]=!0;a.preventDefault()};document.onkeyup=function(a){b.keys[a.keyCode]=!1;a.preventDefault()};this._init=function(a){this.timer=new umu.Timer(this,this.update,a);this.canvas=document.getElementById(c);this.loadingScreen=
new umu.ui.LoadingScreen(this.canvas);this.resources?this.resources.load(b._onFinishLoad,function(a){b.loadingScreen.progress=a;b.loadingScreen.draw()}):this._onFinishLoad()};this._onFinishLoad=function(){if("function"===typeof b.game.onLoaded)b.game.onLoaded();$("#start").show();b.state=STATE_READY;b.timer.start()};this.start=function(){if("function"===typeof b.game.onStart)b.game.onStart();b.resume();$("#start").hide();$("#restart").show()};this.update=function(a){if("function"===typeof b.game.onUpdate)b.game.onUpdate(a);
a=(new Date).getTime();if(0<this.updatePrevTime)this.updateTimeAvg=0<this.updateTimeAvg?0.95*this.updateTimeAvg+0.05*(a-this.updatePrevTime):a-this.updatePrevTime;this.updatePrevTime=a};this.pause=function(){this.state=STATE_PAUSED;$("#pause").hide();$("#resume").show();if("function"===typeof this.game.onPause)this.game.onPause()};this.resume=function(){if("function"===typeof this.game.onResume)this.game.onResume();this.state=STATE_RUNNING;$("#pause").show();$("#resume").hide()};this.finish=function(){this.state=
STATE_FINISHED;$("#pause").hide();if("function"===typeof this.game.onFinish)this.game.onFinish()};this.restart=function(){$("#start").show();$("#pause").hide();$("#resume").hide();$("#restart").hide();this.state=STATE_READY;if("function"===typeof this.game.onRestart)this.game.onRestart()};this.getFPS=function(){return 0==this.updateTimeAvg?0:Math.floor(1E3/this.updateTimeAvg)}};
