/* Umukino :: Copyright Rowan Seymour 2011 */ var umu={ui:{}};function __extends(b,e,a){b.apply(e,a)};function Vector2(b,e){this.x=b;this.y=e;this.clone=function(){return new Vector2(this.x,this.y)};this.add=function(a){return new Vector2(this.x+a.x,this.y+a.y)};this.subtract=function(a){return new Vector2(this.x-a.x,this.y-a.y)};this.scale=function(a){return new Vector2(this.x*a,this.y*a)};this.dot=function(a){return this.x*a.x+this.y*a.y};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};this.length2=function(){return this.x*this.x+this.y*this.y};this.equals=function(a){return this.x==
a.x&&this.y==a.y}};function Timer(b,e,a){this.host=b;this.callback=e;this.idleMs=a;this.timerId=0;eval("$timer_"+this.id+" = this;");this.start=function(){this._requestNextTick()};this.stop=function(){clearTimeout(this.timerId)};this._requestNextTick=function(){this.timerId=setTimeout("$timer_"+this.id+"._tick()",this.idleMs)};this._tick=function(){this.callback.apply(this.host,[(new Date).getTime()]);this._requestNextTick()}};function LoadingScreen(){this.draw=function(b,e){var a=b.getContext("2d");a.font="20pt Courier";a.fillStyle="#000";a.fillRect(0,0,b.width,b.height);a.fillStyle="#FFF";a.fillText("Loading:"+e+"%",5,b.height-5)}};function Resources(){this.imagePaths=[];this.audioPaths=[];this.loadedCount=this.count=0;var b=this;this.addImage=function(b,a){this.imagePaths.push([b,a]);++this.count};this.addAudio=function(b,a){this.audioPaths.push([b,a]);++this.count};this.load=function(b,a){this.loadedCount=0;this.onLoaded=b;this.onProgress=a;this.image={};this.audio={};for(var d=0;d<this.imagePaths.length;++d){var c=this.imagePaths[d][0],f=this.imagePaths[d][1];this.image[c]=new Image;this.image[c].onload=this._onResourceLoad;
this.image[c].src=f}for(d=0;d<this.audioPaths.length;++d)c=this.audioPaths[d][0],f=this.audioPaths[d][1],this.audio[c]=new Audio(f),this._bindEvent(this.audio[c],"canplaythrough",this._onResourceLoad),this.audio[c].load()};this._bindEvent=function(b,a,d){return b.addEventListener(a,function f(){b.removeEventListener(a,f);return d()},!0)};this._onResourceLoad=function(){++b.loadedCount;if("function"===typeof b.onProgress)b.onProgress(100*b.loadedCount/b.count);if(b.loadedCount==b.count&&"function"===
typeof b.onLoaded)b.onLoaded()}};var STATE_LOADING=0,STATE_READY=1,STATE_RUNNING=2,STATE_PAUSED=3,STATE_FINISHED=4,game_count=0;
function Host(b,e,a,d){this.game=b;this.game.host=this;this.resources=e;this.canvas=null;this.loadingScreen=new LoadingScreen;this.state=STATE_LOADING;this.id=++game_count;this.updateTimeAvg=this.updatePrevTime=0;var c=this;$(document).ready(function(){c._init(d)});this.keys=[];document.onkeydown=function(a){c.keys[a.keyCode]=!0;a.preventDefault()};document.onkeyup=function(a){c.keys[a.keyCode]=!1;a.preventDefault()};this._init=function(b){this.timer=new Timer(this,this.update,b);this.canvas=document.getElementById(a);
this.resources?this.resources.load(c._onFinishLoad,function(a){c.loadingScreen.draw(c.canvas,a)}):this._onFinishLoad()};this._onFinishLoad=function(){if("function"===typeof c.game.onLoaded)c.game.onLoaded();$("#start").show();c.state=STATE_READY;c.timer.start()};this.start=function(){if("function"===typeof c.game.onStart)c.game.onStart();c.resume();$("#start").hide();$("#restart").show()};this.update=function(a){if("function"===typeof c.game.onUpdate)c.game.onUpdate(a);a=(new Date).getTime();if(0<
this.updatePrevTime)this.updateTimeAvg=0<this.updateTimeAvg?0.95*this.updateTimeAvg+0.05*(a-this.updatePrevTime):a-this.updatePrevTime;this.updatePrevTime=a};this.pause=function(){clearTimeout(this.timerId);this.state=STATE_PAUSED;$("#pause").hide();$("#resume").show();if("function"===typeof this.game.onPause)this.game.onPause()};this.resume=function(){if("function"===typeof this.game.onResume)this.game.onResume();this.state=STATE_RUNNING;$("#pause").show();$("#resume").hide()};this.finish=function(){this.state=
STATE_FINISHED;$("#pause").hide();if("function"===typeof this.game.onFinish)this.game.onFinish()};this.restart=function(){$("#start").show();$("#pause").hide();$("#resume").hide();$("#restart").hide();this.state=STATE_READY;if("function"===typeof this.game.onRestart)this.game.onRestart()};this.getFPS=function(){return 0==this.updateTimeAvg?0:Math.floor(1E3/this.updateTimeAvg)}};
