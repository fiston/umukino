/* Umukino :: Copyright Rowan Seymour 2011 */ var umu={ui:{}};function __extends(clazz,obj,params){clazz.apply(obj,params)};function Vector2(x,y){this.x=x;this.y=y;this.clone=function(){return new Vector2(this.x,this.y)};this.add=function(v){return new Vector2(this.x+v.x,this.y+v.y)};this.subtract=function(v){return new Vector2(this.x-v.x,this.y-v.y)};this.scale=function(s){return new Vector2(this.x*s,this.y*s)};this.dot=function(v){return this.x*v.x+this.y*v.y};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};this.length2=function(){return this.x*this.x+this.y*this.y};this.equals=function(v){return this.x==
v.x&&this.y==v.y}};function Timer(host,callback,idleMs){this.host=host;this.callback=callback;this.idleMs=idleMs;this.timerId=0;eval("$timer_"+this.id+" = this;");this.start=function(){this._requestNextTick()};this.stop=function(){clearTimeout(this.timerId)};this._requestNextTick=function(){this.timerId=setTimeout("$timer_"+this.id+"._tick()",this.idleMs)};this._tick=function(){var time=(new Date).getTime();this.callback.apply(this.host,[time]);this._requestNextTick()}};function Resources(){this.imagePaths=new Array;this.audioPaths=new Array;this.count=0;this.loadedCount=0;var resources=this;this.addImage=function(key,src){this.imagePaths.push([key,src]);++this.count};this.addAudio=function(key,src){this.audioPaths.push([key,src]);++this.count};this.load=function(onLoaded,onProgress){this.loadedCount=0;this.onLoaded=onLoaded;this.onProgress=onProgress;this.image=new Object;this.audio=new Object;for(var r=0;r<this.imagePaths.length;++r){var key=this.imagePaths[r][0];
var src=this.imagePaths[r][1];this.image[key]=new Image;this.image[key].onload=this._onResourceLoad;this.image[key].src=src}for(var r=0;r<this.audioPaths.length;++r){var key=this.audioPaths[r][0];var src=this.audioPaths[r][1];this.audio[key]=new Audio(src);this._bindEvent(this.audio[key],"canplaythrough",this._onResourceLoad);this.audio[key].load()}};this._bindEvent=function(elem,name,callback){return elem.addEventListener(name,function listener(){elem.removeEventListener(name,listener);return callback()},
true)};this._onResourceLoad=function(){++resources.loadedCount;if(typeof resources.onProgress==="function")resources.onProgress(100*resources.loadedCount/resources.count);if(resources.loadedCount==resources.count&&typeof resources.onLoaded==="function")resources.onLoaded()}};umu.ui.Component=function(parent,x,y,width,height){this.parent=parent;this.x=x;this.y=y;this.width=width;this.height=height;this.children=[];this.layout_x=parent?parent.layout_x+x:0;this.layout_y=parent?parent.layout_y+y:0;if(this.parent)this.parent.children.push(this);this.draw=function(gfx){};this.drawChildren=function(gfx){for(var c=0;c<this.children.length;++c){var child=this.children[c];gfx.translate(child.x,child.y);child.draw(gfx);child.drawChildren(gfx);gfx.translate(-child.x,-child.y)}}};umu.ui.Screen=function(canvas){__extends(umu.ui.Component,this,[null,0,0,canvas.width,canvas.height]);this.canvas=canvas;this.draw=function(){this.drawChildren(this.canvas.getContext("2d"))}};umu.ui.Panel=function(parent,x,y,width,height,fillStyle){__extends(umu.ui.Component,this,[parent,x,y,width,height]);this.fillStyle=fillStyle;this.draw=function(gfx){gfx.fillStyle=fillStyle;gfx.fillRect(0,0,this.width,this.height)}};
umu.ui.Label=function(parent,x,y,width,height,fillStyle,text){__extends(umu.ui.Panel,this,[parent,x,y,width,height,fillStyle]);this.text=text;this.draw=function(gfx){gfx.fillStyle=fillStyle;gfx.fillRect(0,0,this.width,this.height);gfx.textAlign="center";gfx.textBaseline="middle";gfx.fillStyle="#000";gfx.fillText(this.text,this.width/2,this.height/2)}};umu.ui.LoadingScreen=function(canvas){__extends(umu.ui.Screen,this,[canvas]);this.progress=0;this.draw=function(){var gfx=this.canvas.getContext("2d");gfx.font="20pt Courier";gfx.fillStyle="#000";gfx.fillRect(0,0,this.canvas.width,this.canvas.height);gfx.fillStyle="#FFF";gfx.fillText("Loading:"+this.progress+"%",5,this.canvas.height-5)}};var STATE_LOADING=0;var STATE_READY=1;var STATE_RUNNING=2;var STATE_PAUSED=3;var STATE_FINISHED=4;var game_count=0;
function Host(game,resources,canvasId,idleMs){this.game=game;this.game.host=this;this.resources=resources;this.canvas=null;this.state=STATE_LOADING;this.id=++game_count;this.updatePrevTime=0;this.updateTimeAvg=0;var host=this;$(document).ready(function(){host._init(idleMs)});this.keys=new Array;document.onkeydown=function(event){host.keys[event.keyCode]=true;event.preventDefault()};document.onkeyup=function(event){host.keys[event.keyCode]=false;event.preventDefault()};this._init=function(idleMs){this.timer=
new Timer(this,this.update,idleMs);this.canvas=document.getElementById(canvasId);this.loadingScreen=new umu.ui.LoadingScreen(this.canvas);if(this.resources)this.resources.load(host._onFinishLoad,function(progress){host.loadingScreen.draw(host.canvas,progress)});else this._onFinishLoad()};this._onFinishLoad=function(){if(typeof host.game.onLoaded==="function")host.game.onLoaded();$("#start").show();host.state=STATE_READY;host.timer.start()};this.start=function(){if(typeof host.game.onStart==="function")host.game.onStart();
host.resume();$("#start").hide();$("#restart").show()};this.update=function(time){if(typeof host.game.onUpdate==="function")host.game.onUpdate(time);var updateTime=(new Date).getTime();if(this.updatePrevTime>0)if(this.updateTimeAvg>0)this.updateTimeAvg=this.updateTimeAvg*0.95+(updateTime-this.updatePrevTime)*0.05;else this.updateTimeAvg=updateTime-this.updatePrevTime;this.updatePrevTime=updateTime};this.pause=function(){clearTimeout(this.timerId);this.state=STATE_PAUSED;$("#pause").hide();$("#resume").show();
if(typeof this.game.onPause==="function")this.game.onPause()};this.resume=function(){if(typeof this.game.onResume==="function")this.game.onResume();this.state=STATE_RUNNING;$("#pause").show();$("#resume").hide()};this.finish=function(){this.state=STATE_FINISHED;$("#pause").hide();if(typeof this.game.onFinish==="function")this.game.onFinish()};this.restart=function(){$("#start").show();$("#pause").hide();$("#resume").hide();$("#restart").hide();this.state=STATE_READY;if(typeof this.game.onRestart===
"function")this.game.onRestart()};this.getFPS=function(){return this.updateTimeAvg==0?0:Math.floor(1E3/this.updateTimeAvg)}};
