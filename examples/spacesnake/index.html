<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Spacesnake</title>
		<script type="text/javascript" src="../../lib/jquery-1.7.min.js"></script>
		<script type="text/javascript" src="../../js/Vector.js"></script>
		<script type="text/javascript" src="../../js/Resources.js"></script>
		<script type="text/javascript" src="../../js/GameRunner.js"></script>
		<script type="text/javascript">
 
// Globals   	
var CANVAS_SIZE_X = 500;
var CANVAS_SIZE_Y = 500;
var CELL_SIZE = 10;
var CELLS_X = CANVAS_SIZE_X / CELL_SIZE;
var CELLS_Y = CANVAS_SIZE_Y / CELL_SIZE;
var TICK_MS = 50;
var INIT_TAIL_SIZE = 5;
var MOVE_UP = new Vector(0, -1);
var MOVE_DOWN = new Vector(0, 1);
var MOVE_LEFT = new Vector(-1, 0);
var MOVE_RIGHT = new Vector(1, 0);

/**
 * Class for the snake
 */
function Snake(head, length) {
	this.head = head;
	this.tail = new Array();
	this.movement = MOVE_RIGHT;
	this.dead = false;
	
	// Build the initial tail
	for (var t = 1; t <= length; ++t){
		this.tail.push(new Vector(head.x - t, head.y));
	}
	
	/**
	 * Updates the snake every frame
	 */
	this.tick = function(keys) {
		// Change snake movement based on keys
		if (37 in keys && keys[37] && this.movement != MOVE_RIGHT) {
			this.movement = MOVE_LEFT;
		} else if (38 in keys && keys[38] && this.movement != MOVE_DOWN) {
			this.movement = MOVE_UP;
		} else if (39 in keys && keys[39] && this.movement != MOVE_LEFT) {
			this.movement = MOVE_RIGHT;
		} else if (40 in keys && keys[40] && this.movement != MOVE_UP) {
			this.movement = MOVE_DOWN;
		}
		
		// Update tail
		this.tail.pop();
		this.tail.unshift(this.head.clone());
		
		// Move head to new position
		this.head = this.head.add(this.movement);
		
		// Wrap back into board
		if (this.head.x >= CELLS_X)
			this.head.x = 0;
		if (this.head.x < 0)
			this.head.x = CELLS_X - 1;
		if (this.head.y >= CELLS_Y)
			this.head.y = 0;
		if (this.head.y < 0)
			this.head.y = CELLS_Y - 1;
			
		// Check to see if we've eaten ourself
		for (var t = 0; t < this.tail.length; ++t) {
			if (this.head.equals(this.tail[t]))
				this.dead = true;
		}
	}
	
	/**
	 * Draws the snake
	 */
	this.draw = function(gfx) {
		// Draw our tail first
		for (var t = 0; t < this.tail.length; ++t)
			board.drawCell(gfx, this.tail[t].x, this.tail[t].y, "#d4ad68");
		
		// Then the head
		board.drawCell(gfx, this.head.x, this.head.y, this.dead ? "#F00" : "#FFF");
	}
	
	/**
	 * Grows the snake
	 */
	this.grow = function() {
		// Duplicate the last tail cell
		this.tail.push(this.tail[this.tail.length - 1].clone());
	}
	
	/**
	 * Test to see if given cell is part of the snake
	 */
	this.hitTest = function(cell) {
		if (this.head.equals(cell))
			return true;
		for (var t = 0; t < this.tail.length; ++t) {
			if (this.tail[t].equals(cell))
				return true;
		}
		return false;
	}
}

/**
 * Item class
 */
function Item(position) {
	this.position = position;
	
	this.draw = function(gfx) {
		board.drawCell(gfx, this.position.x, this.position.y, "#0F0");
	}
}

/**
 * Board
 */
var board = {
	draw: function(gfx) {
		// Draw board
		gfx.fillStyle = "#000";
		gfx.fillRect(0, 0, CANVAS_SIZE_X, CANVAS_SIZE_Y);
		
		// Draw grid lines
		gfx.beginPath();
		gfx.lineWidth = 1;
		gfx.strokeStyle = "#888";	
		for (var x = 0; x < CELLS_X; ++x) {
			gfx.moveTo(x * CELL_SIZE, 0);
			gfx.lineTo(x * CELL_SIZE, CANVAS_SIZE_Y);
		}
		for (var y = 0; y < CELLS_Y; ++y) {
			gfx.moveTo(0, y * CELL_SIZE);
			gfx.lineTo(CANVAS_SIZE_X, y * CELL_SIZE);
		}	
		gfx.stroke();
	},
	
	drawCell: function(gfx, x, y, style) {
		gfx.fillStyle = style;
		gfx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
	}
}

/**
 * Game object
 */
var game = {
	items: [],
	sndHit: new Audio("munch.ogg"),
		
	/**
	 * Initializes the game so it's ready to start
	 */
	onInit: function() {
		this.snake = new Snake(new Vector(CELLS_X / 2, CELLS_Y / 2), INIT_TAIL_SIZE);
		this.items = new Array(new Item(this.randomFreeCell()));
		this.keys = new Array();
	
		document.onkeydown = function(event) { game.keys[event.keyCode] = true; event.preventDefault(); }
		document.onkeyup = function(event) { game.keys[event.keyCode] = false; event.preventDefault(); }
		
		this.sndHit.load();
		
		// Draw the initialized game
		this.draw();
	},

	/**
	 * Updates the game every frame
	 */
	onUpdate: function() {	
		this.snake.tick(this.keys);
		
		// Has snake eaten an item?
		for (var i = 0; i < this.items.length; ++i) {
			var item = this.items[i];
			if (this.snake.head.equals(item.position)) {
				// Remove this item and add another
				this.items.splice(i, 1);
				this.items.push(new Item(this.randomFreeCell()));
				
				// Grow the snake
				this.snake.grow();
			
				// Update the score and play sound
				$('#score').html(parseInt($('#score').html()) + 1);
				this.sndHit.play();
			}
		}
		
		// Has the snake eaten itself? If so game over
		if (this.snake.dead)
			this.runner.finish();
			
		this.draw();
		
		$("#fps").html(this.runner.getFPS());
	},
	
	onResume: function() {
		this.sndHit.play();
	},
	
	/**
	 * Resets the game
	 */
	onReset: function() {
		$('#score').text("0");
	},
	
	/**
	 * Draws the canvas
	 */
	draw: function() {
		var gfx = document.getElementById("board").getContext("2d");
	
		board.draw(gfx);
		
		// Draw items
		for (var i = 0; i < this.items.length; ++i)
			this.items[i].draw(gfx);
		
		// Draw the snake
		this.snake.draw(gfx);
	},
	
	/**
	 * Returns a random free cell, i.e. not occupied by the snake or any other item 
	 */
	randomFreeCell: function() {
		while (true) {
			var cell = new Vector(Math.floor(Math.random() * CELLS_X), Math.floor(Math.random() * CELLS_Y));
			
			// Check this cell isn't occupied by the snake
			if (this.snake.hitTest(cell))
				continue;
			
			// Or another item	
			for (var i = 0; i < this.items.length; ++i) {
				if (cell.equals(this.items[i].position))
					continue;
			}
			
			return cell;
		}
	}
}

//var resources = new Resources(function() { alert("Loaded!"); });
//resources.addAudio("munch", "munch.ogg");
//resources.load();

/**
 * The runner which will control the game
 */
var runner = new GameRunner(game, TICK_MS); 

    	</script>
    	<style type="text/css">
* {
	color: white;
	font-family: Helvetica, sans-serif;
}
body {
	background-color: black;
	margin: 0px;
	padding: 0px;
}
#board {
	border: 1px solid #888;
}
input {
	width: 100px;
	font-size: 16px;
	color: black;
}
#score {
	font-size: 70px;
}
    	</style>
    </head>
	<body onload="runner.init();">
		<div align="center">
			<table border="0" cellpadding="10" cellspacing="0">
				<tr>
					<td valign="top">
						<img src="spacesnake.gif" />
						<br />
						<div style="background-color: #444; padding: 5px; border-radius: 3px;">
							<input id="start" type="button" value="Start" 
								onclick="runner.start();" 
							/>
							<input id="pause" type="button" value="Pause" style="display: none;" 
								onclick="runner.pause();"
							/>
							<input id="resume" type="button" value="Resume" style="display: none;"
								onclick="runner.resume();"
							/>
							<input id="reset" type="button" value="Reset" style="display: none;"
								onclick="runner.reset();"
							/>
							<div style="float: right">
								FPS:
								<span id="fps" style="font-weight: bold">0</span>
							</div>
						</div>
						<br />
						Score
						<br />
						<span id="score">0</span>
					</td>
					<td><canvas id="board" width="500" height="500"></canvas></td>
				</tr>
			</table>
		</div>
	</body>
</html>