<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Spacesnake</title>
		<script type="text/javascript" src="../../lib/jquery-1.7.min.js"></script>
		<script type="text/javascript" src="../../js/Vector.js"></script>
		<script type="text/javascript" src="../../js/Resources.js"></script>
		<script type="text/javascript" src="../../js/Game.js"></script>
		<script type="text/javascript" src="Snake.js"></script>
		<script type="text/javascript">
 
// Globals   	
var CANVAS_SIZE_X = 500;
var CANVAS_SIZE_Y = 500;
var CELL_SIZE = 10;
var CELLS_X = CANVAS_SIZE_X / CELL_SIZE;
var CELLS_Y = CANVAS_SIZE_Y / CELL_SIZE;
var TICK_MS = 100;
var INIT_TAIL_SIZE = 5;
var MOVE_UP = new Vector(0, -1);
var MOVE_DOWN = new Vector(0, 1);
var MOVE_LEFT = new Vector(-1, 0);
var MOVE_RIGHT = new Vector(1, 0);

/**
 * Item class
 */
function Item(position) {
	this.position = position;
	
	this.draw = function(gfx) {
		board.drawCell(gfx, this.position.x, this.position.y, "#0F0");
	};
}

/**
 * Board
 */
var board = {
	draw: function(gfx) {
		// Draw board
		gfx.fillStyle = "#000";
		gfx.fillRect(0, 0, CANVAS_SIZE_X, CANVAS_SIZE_Y);
		
		// Draw grid lines
		gfx.beginPath();
		gfx.lineWidth = 1;
		gfx.strokeStyle = "#888";	
		for (var x = 0; x < CELLS_X; ++x) {
			gfx.moveTo(x * CELL_SIZE, 0);
			gfx.lineTo(x * CELL_SIZE, CANVAS_SIZE_Y);
		}
		for (var y = 0; y < CELLS_Y; ++y) {
			gfx.moveTo(0, y * CELL_SIZE);
			gfx.lineTo(CANVAS_SIZE_X, y * CELL_SIZE);
		}	
		gfx.stroke();
	},
	
	drawCell: function(gfx, x, y, style) {
		gfx.fillStyle = style;
		gfx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
	}
}

/**
 * Game content
 */
var spacesnake = {
	items: [],
		
	/**
	 * Initializes the game so it's ready to start
	 */
	onInit: function() {
		this.snake = new Snake(new Vector(CELLS_X / 2, CELLS_Y / 2), INIT_TAIL_SIZE);
		this.items = new Array(new Item(this.randomFreeCell()));
		
		// Draw the initialized game
		this.draw();
	},

	/**
	 * Updates the game every frame
	 */
	onUpdate: function() {	
		this.snake.update(this.host.keys);
		
		// Has snake eaten an item?
		for (var i = 0; i < this.items.length; ++i) {
			var item = this.items[i];
			if (this.snake.head.equals(item.position)) {
				// Remove this item and add another
				this.items.splice(i, 1);
				this.items.push(new Item(this.randomFreeCell()));
				
				// Grow the snake
				this.snake.grow();
			
				// Update the score and play sound
				$('#score').html(parseInt($('#score').html()) + 1);
				resources.audio.munch.play();
			}
		}
		
		// Has the snake eaten itself? If so game over
		if (this.snake.dead) {
			resources.audio.explosion.play();
			this.host.finish();
		}
			
		this.draw();
		
		$("#fps").html(this.host.getFPS());
	},
	
	/**
	 * Resets the game
	 */
	onReset: function() {
		$('#score').text("0");
	},
	
	/**
	 * Draws the canvas
	 */
	draw: function() {
		var gfx = document.getElementById("board").getContext("2d");
	
		board.draw(gfx);
		
		// Draw items
		for (var i = 0; i < this.items.length; ++i)
			this.items[i].draw(gfx);
		
		// Draw the snake
		this.snake.draw(gfx);
	},
	
	/**
	 * Returns a random free cell, i.e. not occupied by the snake or any other item 
	 */
	randomFreeCell: function() {
		while (true) {
			var cell = new Vector(Math.floor(Math.random() * CELLS_X), Math.floor(Math.random() * CELLS_Y));
			
			// Check this cell isn't occupied by the snake
			if (this.snake.hitTest(cell))
				continue;
			
			// Or another item	
			for (var i = 0; i < this.items.length; ++i) {
				if (cell.equals(this.items[i].position))
					continue;
			}
			
			return cell;
		}
	}
}

var resources = new Resources(function() {});
resources.addAudio("munch", "munch.ogg");
resources.addAudio("explosion", "explosion.ogg");
resources.load();

/**
 * Game host
 */
var game = new Game(spacesnake, TICK_MS); 

    	</script>
    	<style type="text/css">
* {
	color: white;
	font-family: Helvetica, sans-serif;
}
body {
	background-color: black;
	margin: 0px;
	padding: 0px;
}
#board {
	border: 1px solid #888;
}
input {
	width: 100px;
	font-size: 16px;
	color: black;
}
#score {
	font-size: 70px;
}
    	</style>
    </head>
	<body onload="game.init();">
		<div align="center">
			<table border="0" cellpadding="10" cellspacing="0">
				<tr>
					<td valign="top">
						<img src="spacesnake.gif" />
						<br />
						<div style="background-color: #444; padding: 5px; border-radius: 3px;">
							<input id="start" type="button" value="Start" 
								onclick="game.start();" 
							/>
							<input id="pause" type="button" value="Pause" style="display: none;" 
								onclick="game.pause();"
							/>
							<input id="resume" type="button" value="Resume" style="display: none;"
								onclick="game.resume();"
							/>
							<input id="reset" type="button" value="Reset" style="display: none;"
								onclick="game.reset();"
							/>
							<div style="float: right">
								FPS:
								<span id="fps" style="font-weight: bold">0</span>
							</div>
						</div>
						<br />
						Score
						<br />
						<span id="score">0</span>
					</td>
					<td><canvas id="board" width="500" height="500"></canvas></td>
				</tr>
			</table>
		</div>
	</body>
</html>